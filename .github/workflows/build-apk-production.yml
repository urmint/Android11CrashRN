name: Build Production APK

on:
    workflow_dispatch:

jobs:
    build-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Setup Java JDK
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Cache node modules
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      .yarn/cache
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Cache Metro bundler
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ github.workspace }}/.metro
                      ${{ github.workspace }}/node_modules/.cache
                  key: ${{ runner.os }}-metro-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-metro-

            - name: Build Release APK
              working-directory: ./android
              run: ./gradlew assembleRelease --no-daemon --build-cache

            - name: Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: app-release
                  path: android/app/build/outputs/apk/release/app-release.apk
                  retention-days: 30
